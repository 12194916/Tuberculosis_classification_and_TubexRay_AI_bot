# -*- coding: utf-8 -*-
"""TubexRay_AI_bot.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1aJBbRgA6WxdeCBY5P9dKQAPf20M3Cz5I
"""

import telebot
import numpy as np
from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing.image import load_img, img_to_array
import tensorflow
from telebot import types

model = load_model('my_model.h5')

# Initialize the Telegram bot
bot = telebot.TeleBot('....')

# Define language constants
UZBEK = 'uz'
ENGLISH = 'en'
RUSSIAN = 'ru'

uz_welcome='''- Assalomu alaykum, Men dasturchi Muhammadyusuf tomonidan tarbiyalangan sun'iy intellektman. 

- Bemorning o'pka rengin rasmiga qarab, bemorda sil kasalligi bor yo'q ekanligini anqlab beraman.
  
- Mening anqliligim juda yuqori. Men tarbiyalangan rasmlar,  malakalik shifokorlar tomonidan ko'rib chiqilgan va tasdiqlangan.

- Muhim: Men test rejimida ishlamoqdaman, iltimos, menga ishonib hulosa qilmang, malakalik shifokorga murojat qiling.

Boshlash uchun, iltimos bemor o'pkasining rengin rasmini yuboring. '''

en_welcome='''- Hello, I am a trained artificial intelligence by developer Muhammadyusuf

- Looking at the picture of the patient's lungs, I can determine whether the patient has tuberculosis or not.
  
- I have really high accuracy. I was trained with pictures, carefully reviewed and approved by professional doctors.

- Important: I am working in test mode, please do not have a conclusion based on my responce, consult a qualified doctor.

To begin, please send the XRay image of the patient's lungs. '''

rus_welcome='''- Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ, Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ð¹ Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ Ð¾Ñ‚ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ° ÐœÑƒÑ…Ð°Ð¼Ð¼Ð°Ð´ÑŽÑÑƒÑ„Ð°.

- Ð“Ð»ÑÐ´Ñ Ð½Ð° ÑÐ½Ð¸Ð¼Ð¾Ðº Ð»ÐµÐ³ÐºÐ¸Ñ… Ð±Ð¾Ð»ÑŒÐ½Ð¾Ð³Ð¾, Ñ Ð¼Ð¾Ð³Ñƒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ð±Ð¾Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÑƒÐ±ÐµÑ€ÐºÑƒÐ»ÐµÐ· Ð¸Ð»Ð¸ Ð½ÐµÑ‚.
  
- Ð£ Ð¼ÐµÐ½Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²Ñ‹ÑÐ¾ÐºÐ°Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ. ÐœÐµÐ½Ñ Ð¾Ð±ÑƒÑ‡Ð°Ð»Ð¸ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÑÐ¼, Ñ‚Ñ‰Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð½Ñ‹Ð¼ Ð¸ Ð¾Ð´Ð¾Ð±Ñ€ÐµÐ½Ð½Ñ‹Ð¼ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð²Ñ€Ð°Ñ‡Ð°Ð¼Ð¸.

- Ð’Ð°Ð¶Ð½Ð¾: Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ðµ Ð´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð²Ñ‹Ð²Ð¾Ð´ Ð¿Ð¾ Ð¼Ð¾ÐµÐ¼Ñƒ Ð¾Ñ‚Ð²ÐµÑ‚Ñƒ, Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº ÐºÐ²Ð°Ð»Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ð²Ñ€Ð°Ñ‡Ñƒ. 

Ð”Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ€ÐµÐ½Ñ‚Ð³ÐµÐ½Ð¾Ð²ÑÐºÐ¸Ð¹ ÑÐ½Ð¸Ð¼Ð¾Ðº Ð»ÐµÐ³ÐºÐ¸Ñ… Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð°.'''


# Define welcome messages
WELCOME_MESSAGES = {
    UZBEK: uz_welcome,
    ENGLISH: en_welcome,
    RUSSIAN: rus_welcome,
}


user_data = {}

# Handler function for the language selection buttons
@bot.message_handler(commands=['start'])
def send_welcome(message):
    # Create the keyboard markup with the language selection buttons
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1)
    markup.add(
        types.KeyboardButton(text='ðŸ‡ºðŸ‡¿ O\'zbek'),
        types.KeyboardButton(text='ðŸ‡¬ðŸ‡§ English'),
        types.KeyboardButton(text='ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹')
    )
    
    # Send the welcome message with the language selection buttons
    msg = bot.send_message(message.chat.id, 'Tilni tanlang / Please select your language / Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº', reply_markup=markup)
    
    # Store the selected language in the user data for future use
    bot.register_next_step_handler(msg, process_language_selection)

# Handler function for processing the language selection
def process_language_selection(message):
    try:
        # Get the selected language from the button text
        flag_emoji, language_name = message.text.split()
        selected_language = {
            'ðŸ‡ºðŸ‡¿': UZBEK,
            'ðŸ‡¬ðŸ‡§': ENGLISH,
            'ðŸ‡·ðŸ‡º': RUSSIAN
        }[flag_emoji]

        # Store the selected language in the user data for future use
        user_data[message.chat.id] = {'language': selected_language}

        # Send the welcome message in the selected language
        welcome_message = WELCOME_MESSAGES[selected_language]
        markup = types.ReplyKeyboardRemove(selective=False)
        bot.send_message(message.chat.id, welcome_message, reply_markup=markup)
    except:
        # If an error occurs, ask the user to select a language
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1)
        markup.add(
            types.KeyboardButton(text='ðŸ‡ºðŸ‡¿ O\'zbek'),
            types.KeyboardButton(text='ðŸ‡¬ðŸ‡§ English'),
            types.KeyboardButton(text='ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹')
        )
        msg = bot.send_message(message.chat.id, 'Tilni tanlang / Please select your language / Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº', reply_markup=markup)
        bot.register_next_step_handler(msg, process_language_selection)



# Define the function for processing the image
@bot.message_handler(content_types=['photo'])
def process_image(message):
    # Download the image and save it locally
    file_info = bot.get_file(message.photo[-1].file_id)
    downloaded_file = bot.download_file(file_info.file_path)
    with open('image.jpg', 'wb') as new_file:
        new_file.write(downloaded_file)

    # Load the image and convert it to RGB color mode
    img = load_img('image.jpg', target_size=(28, 28))
    img = img.convert('RGB')

    bot.send_chat_action(message.chat.id, 'typing')

    # Preprocess the image for the model
    img = img_to_array(img)
    img = np.expand_dims(img, axis=0)
    img = img / 255.0

    CLASS_NAMES = {
    UZBEK: {
        'healthy': "Sog'lom",
        'sick': 'Bemorda sil kasalligi mavjud',
    },
    ENGLISH: {
        'healthy': "Healthy",
        'sick': 'The patient has tuberculosis',
    },
    RUSSIAN: {
        'healthy': "Ð—Ð´Ð¾Ñ€Ð¾Ð²Ñ‹Ð¹",
        'sick': 'Ð£ Ð±Ð¾Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÑƒÐ±ÐµÑ€ÐºÑƒÐ»Ñ‘Ð·',
    },
    }

    # Use the model to make a prediction
    prediction = model.predict(img)
    bot.send_chat_action(message.chat.id, 'typing')
    
    selected_language = user_data[message.chat.id]['language']

    # Map the class names to the selected language
    class_names = CLASS_NAMES[selected_language]

    # Get the predicted class index and corresponding class name
    if np.argmax(prediction) > 0.5:
        class_name = class_names['sick']
    else:
        class_name = class_names['healthy']

    # Send the prediction to the user
    bot.reply_to(message, class_name)



# Start the bot
bot.polling()
